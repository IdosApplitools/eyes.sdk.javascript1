name: 'Tests'
description: 'Run tests for a package'
inputs:
  package:
    description: "name of the package"
    required: true
  install:
    description: "name and version of the framework to install"
  links:
    description: "links"
  linking-depth:
    description: "linking depth"
    default: 0
  grep:
    description: "grep"
  report:
    description: "report level"
    default: "sandbox"
runs:
  using: "composite"
  steps:
    - shell: bash
      env:
        MOCHA_GREP: ${{inputs.grep}}
      run: |
        echo "::group::Configure NPM"
        echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
        echo "registry=https://registry.npmjs.org/" >> .npmrc
        echo "always-auth=true" >> .npmrc
        echo "::endgroup::"

        cd "packages/${{inputs.package}}"
        yarn install
        npm run deps --if-present -- --skip-commit

        if [ ! -z "${{inputs.links}}" ]
        then
          yarn install --cwd "../sdk-shared"
          npm run link --if-present -- --include ${{inputs.links}} --build --install --depth ${{inputs['linking-depth']}}
        fi

        if [ ! -z "${{inputs.install}}" ]; then yarn add --dev ${{inputs.install}}; fi

        npm run build --if-present
        npm run setup --if-present
        npm run test

        if [ "${{inputs.sandbox}}" = "sandbox" ]; then npm run report --if-present -- --sandbox; else npm run report --if-present; fi

        cat coverage-test-report.xml || echo "failed to cat coverage-test-report.xml file"
